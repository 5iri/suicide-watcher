name: GitHub → Discord Notifications

on:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes (minimum interval GitHub supports)
  workflow_dispatch:        # allow manual run

permissions:
  contents: read
  issues: read
  pull-requests: read
  actions: read
  # Requires a classic PAT with notifications scope provided via NOTIFICATIONS_TOKEN.

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      DISCORD_USER_ID: ${{ secrets.DISCORD_USER_ID }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NOTIFICATIONS_TOKEN: ${{ secrets.NOTIFICATIONS_TOKEN }}
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch unread GitHub notifications
        id: fetch
        run: |
          set -euo pipefail

          if [ -z "${NOTIFICATIONS_TOKEN:-}" ]; then
            echo "Missing NOTIFICATIONS_TOKEN secret. Create a classic PAT with 'notifications' scope and add it as repository secret NOTIFICATIONS_TOKEN."
            exit 1
          fi

          API_URL="https://api.github.com/notifications?per_page=50"
          echo "Fetching unread notifications..."

          HTTP_STATUS=$(curl -sS -w "%{http_code}" -o notifications.json \
            -H "Authorization: Bearer $NOTIFICATIONS_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL")

          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "GitHub API call failed with HTTP $HTTP_STATUS:"
            cat notifications.json
            exit 1
          fi

          if ! jq -e 'type == "array"' notifications.json > /dev/null; then
            echo "Expected an array of notifications but got:"
            cat notifications.json
            exit 1
          fi

          COUNT=$(jq 'length' notifications.json)
          echo "Fetched $COUNT notifications."
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Post to Discord & mark as read
        if: steps.fetch.outputs.count != '0'
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "Missing DISCORD_WEBHOOK_URL secret. Add it to the repository secrets."
            exit 1
          fi

          WEBHOOK_URL=$(printf "%s" "$DISCORD_WEBHOOK_URL" | tr -d '\r\n')
          if [ -z "$WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL evaluates to an empty string after trimming; check your secret value."
            exit 1
          fi

          if [ ! -s notifications.json ]; then
            echo "notifications.json is missing; aborting."
            exit 1
          fi

          USER_ID="${DISCORD_USER_ID:-}"
          if [ -z "$USER_ID" ]; then
            echo "DISCORD_USER_ID secret not set; notifications will be sent without a mention."
          fi

          # For each notification, resolve an HTML link, post to Discord, then mark the thread as read
          jq -c '.[]' notifications.json | while IFS= read -r row; do
            THREAD_ID=$(jq -r '.id' <<<"$row")
            REPO=$(jq -r '.repository.full_name' <<<"$row")
            TITLE=$(jq -r '.subject.title' <<<"$row")
            TYPE=$(jq -r '.subject.type' <<<"$row")
            REASON=$(jq -r '.reason' <<<"$row")
            SUBJECT_URL=$(jq -r '.subject.latest_comment_url // .subject.url // empty' <<<"$row")

            # Resolve an html_url for a nice link (best effort)
            HTML_URL=""
            if [ -n "$SUBJECT_URL" ]; then
              RESP=$(curl -sS -H "Authorization: Bearer $NOTIFICATIONS_TOKEN" -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" "$SUBJECT_URL")
              HTML_URL=$(echo "$RESP" | jq -r '.html_url // empty')
              if [ -z "$HTML_URL" ]; then
                # crude fallback: transform API URL to web URL
                RAW_URL=$(echo "$RESP" | jq -r '.url // empty')
                if [ -n "$RAW_URL" ]; then
                  HTML_URL=$(echo "$RAW_URL" | sed 's#https://api.github.com/repos/#https://github.com/#; s#/pulls/#/pull/#')
                fi
              fi
            fi
            if [ -z "$HTML_URL" ]; then
              HTML_URL="(link unavailable)"
            fi

            # Make the reason human-friendly
            case "$REASON" in
              assign) WHY="assigned you" ;;
              author) WHY="your thread" ;;
              comment) WHY="new comment" ;;
              invitation) WHY="invited" ;;
              manual) WHY="subscribed" ;;
              mention) WHY="mentioned you" ;;
              review_requested) WHY="requested your review" ;;
              security_alert) WHY="security alert" ;;
              state_change) WHY="state changed" ;;
              subscribed) WHY="subscribed thread" ;;
              team_mention) WHY="team mention" ;;
              *) WHY="$REASON" ;;
            esac

            # Build the Discord message
            BODY="**${REPO}** • **${TYPE}** • ${WHY}\n**${TITLE}**\n${HTML_URL}"
            if [ -n "$USER_ID" ]; then
              CONTENT="<@${USER_ID}>\n${BODY}"
              PAYLOAD=$(jq -n --arg content "$CONTENT" --arg uid "$USER_ID" '{content: $content, allowed_mentions: {users: [$uid]}}')
            else
              CONTENT="$BODY"
              PAYLOAD=$(jq -n --arg content "$CONTENT" '{content: $content}')
            fi

            # Send to Discord webhook
            curl -sS -X POST "$WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD"

            # Mark the notification thread as read to avoid duplicates next run
            curl -sS -X PATCH \
              -H "Authorization: Bearer $NOTIFICATIONS_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              https://api.github.com/notifications/threads/${THREAD_ID} > /dev/null
          done
